DECLARE @CurrentMigration [nvarchar](max)

IF object_id('[dbo].[__MigrationHistory]') IS NOT NULL
    SELECT @CurrentMigration =
        (SELECT TOP (1) 
        [Project1].[MigrationId] AS [MigrationId]
        FROM ( SELECT 
        [Extent1].[MigrationId] AS [MigrationId]
        FROM [dbo].[__MigrationHistory] AS [Extent1]
        WHERE [Extent1].[ContextKey] = N'MovieNetDbProject.ModelMovieNet'
        )  AS [Project1]
        ORDER BY [Project1].[MigrationId] DESC)

IF @CurrentMigration IS NULL
    SET @CurrentMigration = '0'

IF @CurrentMigration < '201709191225334_addDatesToMovies'
BEGIN
    IF object_id(N'[dbo].[FK_dbo.film_dbo.genre_genre_id]', N'F') IS NOT NULL
        ALTER TABLE [dbo].[film] DROP CONSTRAINT [FK_dbo.film_dbo.genre_genre_id]
    IF object_id(N'[dbo].[FK_dbo.commentaire_dbo.film_film_id]', N'F') IS NOT NULL
        ALTER TABLE [dbo].[commentaire] DROP CONSTRAINT [FK_dbo.commentaire_dbo.film_film_id]
    IF object_id(N'[dbo].[FK_dbo.note_dbo.film_film_id]', N'F') IS NOT NULL
        ALTER TABLE [dbo].[note] DROP CONSTRAINT [FK_dbo.note_dbo.film_film_id]
    IF object_id(N'[dbo].[FK_dbo.note_dbo.utilisateur_utilisateur_id]', N'F') IS NOT NULL
        ALTER TABLE [dbo].[note] DROP CONSTRAINT [FK_dbo.note_dbo.utilisateur_utilisateur_id]
    IF EXISTS (SELECT name FROM sys.indexes WHERE name = N'IX_genre_id' AND object_id = object_id(N'[dbo].[film]', N'U'))
        DROP INDEX [IX_genre_id] ON [dbo].[film]
    DECLARE @var0 nvarchar(128)
    SELECT @var0 = name
    FROM sys.default_constraints
    WHERE parent_object_id = object_id(N'dbo.commentaire')
    AND col_name(parent_object_id, parent_column_id) = 'id_film';
    IF @var0 IS NOT NULL
        EXECUTE('ALTER TABLE [dbo].[commentaire] DROP CONSTRAINT [' + @var0 + ']')
    ALTER TABLE [dbo].[commentaire] DROP COLUMN [id_film]
    DECLARE @var1 nvarchar(128)
    SELECT @var1 = name
    FROM sys.default_constraints
    WHERE parent_object_id = object_id(N'dbo.commentaire')
    AND col_name(parent_object_id, parent_column_id) = 'id_utilisateur';
    IF @var1 IS NOT NULL
        EXECUTE('ALTER TABLE [dbo].[commentaire] DROP CONSTRAINT [' + @var1 + ']')
    ALTER TABLE [dbo].[commentaire] DROP COLUMN [id_utilisateur]
    DECLARE @var2 nvarchar(128)
    SELECT @var2 = name
    FROM sys.default_constraints
    WHERE parent_object_id = object_id(N'dbo.note')
    AND col_name(parent_object_id, parent_column_id) = 'id_film';
    IF @var2 IS NOT NULL
        EXECUTE('ALTER TABLE [dbo].[note] DROP CONSTRAINT [' + @var2 + ']')
    ALTER TABLE [dbo].[note] DROP COLUMN [id_film]
    DECLARE @var3 nvarchar(128)
    SELECT @var3 = name
    FROM sys.default_constraints
    WHERE parent_object_id = object_id(N'dbo.note')
    AND col_name(parent_object_id, parent_column_id) = 'id_utilisateur';
    IF @var3 IS NOT NULL
        EXECUTE('ALTER TABLE [dbo].[note] DROP CONSTRAINT [' + @var3 + ']')
    ALTER TABLE [dbo].[note] DROP COLUMN [id_utilisateur]
    EXECUTE sp_rename @objname = N'dbo.commentaire.film_id', @newname = N'id_film', @objtype = N'COLUMN'
    EXECUTE sp_rename @objname = N'dbo.commentaire.utilisateur_id', @newname = N'id_utilisateur', @objtype = N'COLUMN'
    EXECUTE sp_rename @objname = N'dbo.note.film_id', @newname = N'id_film', @objtype = N'COLUMN'
    EXECUTE sp_rename @objname = N'dbo.note.utilisateur_id', @newname = N'id_utilisateur', @objtype = N'COLUMN'
    EXECUTE sp_rename @objname = N'dbo.commentaire.IX_film_id', @newname = N'IX_id_film', @objtype = N'INDEX'
    EXECUTE sp_rename @objname = N'dbo.commentaire.IX_utilisateur_id', @newname = N'IX_id_utilisateur', @objtype = N'INDEX'
    EXECUTE sp_rename @objname = N'dbo.note.IX_film_id', @newname = N'IX_id_film', @objtype = N'INDEX'
    EXECUTE sp_rename @objname = N'dbo.note.IX_utilisateur_id', @newname = N'IX_id_utilisateur', @objtype = N'INDEX'
    ALTER TABLE [dbo].[commentaire] DROP CONSTRAINT [PK_dbo.commentaire]
    ALTER TABLE [dbo].[note] DROP CONSTRAINT [PK_dbo.note]
    ALTER TABLE [dbo].[commentaire] ADD [id_commentaire] [int] NOT NULL IDENTITY
    ALTER TABLE [dbo].[film] ADD [register_date] [datetime] NOT NULL DEFAULT '1900-01-01T00:00:00.000'
    ALTER TABLE [dbo].[film] ADD [release_date] [datetime] NOT NULL DEFAULT '1900-01-01T00:00:00.000'
    ALTER TABLE [dbo].[note] ADD [id_note] [int] NOT NULL IDENTITY
    ALTER TABLE [dbo].[commentaire] ADD CONSTRAINT [PK_dbo.commentaire] PRIMARY KEY ([id_commentaire])
    ALTER TABLE [dbo].[note] ADD CONSTRAINT [PK_dbo.note] PRIMARY KEY ([id_note])
    ALTER TABLE [dbo].[commentaire] ADD CONSTRAINT [FK_dbo.commentaire_dbo.film_id_film] FOREIGN KEY ([id_film]) REFERENCES [dbo].[film] ([id_film]) ON DELETE CASCADE
    ALTER TABLE [dbo].[note] ADD CONSTRAINT [FK_dbo.note_dbo.film_id_film] FOREIGN KEY ([id_film]) REFERENCES [dbo].[film] ([id_film]) ON DELETE CASCADE
    ALTER TABLE [dbo].[note] ADD CONSTRAINT [FK_dbo.note_dbo.utilisateur_id_utilisateur] FOREIGN KEY ([id_utilisateur]) REFERENCES [dbo].[utilisateur] ([id_utilisateur]) ON DELETE CASCADE
    DECLARE @var4 nvarchar(128)
    SELECT @var4 = name
    FROM sys.default_constraints
    WHERE parent_object_id = object_id(N'dbo.film')
    AND col_name(parent_object_id, parent_column_id) = 'id_genre';
    IF @var4 IS NOT NULL
        EXECUTE('ALTER TABLE [dbo].[film] DROP CONSTRAINT [' + @var4 + ']')
    ALTER TABLE [dbo].[film] DROP COLUMN [id_genre]
    INSERT [dbo].[__MigrationHistory]([MigrationId], [ContextKey], [Model], [ProductVersion])
    VALUES (N'201709191225334_addDatesToMovies', N'MovieNetDbProject.ModelMovieNet',  0x1F8B0800000000000400ED5CCD6EE33610BE17E83B083A16D928C9628136B077B1EBAC17411B67B14E16BD058C443B6C254A95A82041D127EBA18FD457E8E8D7A4F823CA76EC6C11E49288E4C7E1CC379C2135CABF7FFF337AF71085CE3D4E3312D3B17B7C78E43A98FA7140E872ECE66CF1EA47F7DDDBEFBF1B7D0CA207E76BD3EF75D10F46D26CECDE31969C7A5EE6DFE108658711F1D3388B17ECD08F230F05B1777274F493777CEC61807001CB71465F72CA4884CB3FE0CF494C7D9CB01C85177180C3AC7E0E2DF312D599A1086709F2F1D8BD88EF099E617676FB398D7FC33E739DF7214120C81C870BD74194C60C3110F3F43AC37396C674394FE0010AAF1E130CFD1628CC702DFEE9AABBED4A8E4E8A9578AB810D949F672C8E06021EBFAE55E37587AFA560B7551D28EF2328993D16AB2E15387627711461CA104961FDDDF94E27615AF455A8F8901B78E048CD072D31803FC5CF8133C94396A7784C71CE52141E389FF3DB90F83FE3C7ABF8774CC7340F435E569016DA8407F008F0139CB2C72F7851AF8004AEE389E3BCEEC0761837A65AD83965AF4F5C670693A3DB10B754E0943067718A3F618A53C470F019318653B0E479804B654AB34B73DD2C4818F54DD80B923312920C44C8D3CDB07CDEE41510F80478B7EB5CA0875F305DB23BB0387A709D2979C041F3A406BFA6043603ED6433744F96A5E23AD3564AF882C3B231BB2349E59F875368B811849AA671F4252E16D46DBBB942E91283835FC59A0EF3384FFD0162096A554877BD6AD709A9E922C9AAEBA71279E4AD5CD5E8C0D352AD433CB718F1E2B2A6B9A00F9885F75A85839CBC7963E72003DD33C5591EF5CEBEAE7B4A932D4906CAB9094051CD7467F0FB15C4E235440F31CAF076C096988211FACD6EEBE882F36EBA0D352EABDD861ADFB7950EA86B10AB6AEDC8533C540B52B6A824B0DE5566E58443769562C4CBAEF24D250215ABB6E35DE6E8AEE7AF329E0BCC7E8A40DE95A7DB660CDD5AE9ACBDEB9A1775889371035F7CCD4CED48E5273B0CE3498AF72F4414247B96C08F29056AB6FBCC8718FC09D1E1FB1ECDFC94B0C1306BA7031BE4FDDD98DC773ED8384718B4B599A4DB3C71F854646DC336B572C8CB76669A0B707178B3AC74FBC43EAC33F5FB2C8B7D522E873B7A0ABE21AEE1230D9CBEF4B95A4A9327C06AC0C0240193820063F7D8ED9AEE929EC1198361E7BD5FDDA74D50E6A340F67B5844602D4E1BED57E208F762A2543F48930191705A58128513704CA026A14C661DA13E4950D8A394CE384BBE164B6E67E8B69CE104D3826A3D0AB09BBACE62E5F9DB693AA6E853CFC8E3B865A69C6E57D699BA778B5E595C48CABA3CEC5ABC7F86BD70AA67B93BA0568F3A2C1926E42C7B275A19526DEC2FC6574B6A3DC916A73FD0ACA4AACEF84FCE435E293B2620BFF26F8679AB03B3317EE9B8B6EB38BA077649EBDF55C85C834F3B8B9555D2066360BF8534B396A07C79DA64D68AB4FC3AC375669E8D5D96E632E90AD43966AA53D32A4F54053829628A4895622488A9425FD2D8EA8C238DAD28D73356707009E25AEFFE12529D8E4B18F511A8339A33DB0A42BE73E6BAE9EEA5BB5CB2C8B35BD11BBD4B84B4C88E3910DF60684F5CA98516B4476D591956F9DFA00C905B9579EFB74FF976A2A8CA07CC1A92A3885DEAB2A14E8490C06151957F0ED70277A3ACF1969E75CBF173B07F6C6989CD59BBDDB6DBB69157D5B9D40F469EA6206674819284D0255720533F71E65575CCE4D57C78DD485461787EA6281F69A56D6762718A96B8D35A149704784AD28C9D21866E5171D3300922A99B18A4349B6E33971C876453351B7233A6F8BD8987863A16454CAF11A6B0BCA257B952CCD9DB38DA298A95508852C5CDD1240EF388B66982619F3023D50946074E4D62238EE0E81D38E326A0471516C543F6AC76E475D42E654F9289A5A455648D15A74AA56D46A6A902C28245EA6103E833D4DE7C81030FC53FB747132A167838A161089E509420220A4D4330F9D20411926FB1475CD527F068ABA7CF86D79A683884D733058405AFD5C306F05A154ECD10CF793FAC56C363E9D6B727A6F0EBDA8C30D77A240BDE18470FA0CFDA768AF4E6971AED7155AF84796855BB3DBAF4AE9787961A8744F1E60DAE18C29BA703BCAA79872B98A979F86CBCA03AD76FC6FF4F2A0C0BE66BC60DE0FC5275FB60C210DE2DF26042C38EAD231D8CBA5DDAD9DB0352E72034AA0F25FD9F0F48A794AA8BEB80A2EE49509C50E68F907444874587C3F91FE12424B0DE55870B44C90267AC7A09ED9E1C1D9F743E41783E9F03785916848A439DE69B00D164962FD34DC7199B17EB429D1CA1AA8BCB731AE087B1FB6739E6D439FFF5A61E76E05CA6609253E7C8F96B4BD5750324E0466F2A88A24CBF14A4B79460F3CF01187E603C4E7931BC4179FA7A2452256DEBB167DB2A93EBC3EF51EADFA1542EC7D8BCF8BBDF182A18455977F13BDB5659F7DA60DDB2EED2406B15A4485C938F1BD65C53DFDBBDEC545682F075C44FE26FD204DBE18BF698614D1B434A6DC51E9D09B7AF406525EAB6762D7DADEBB666D014B26E0BBE5BA57A4BFA48A630A758A1DA0F31B0A6723D862AD3772B6E0AD5864FC24A4555E37A067DA292C57DD5554CE48C6C8735899B563658975498DFBCFC8F2A0FB75166B83F4E98AFF2D629A27A4A86ECBF7E6B9DCAC13D570BCEB8FC6A87A581BBA693E62DC633E5915D1DE0BE62D42E29B3D3A83484247B2EEE93CB2B34F7DB8A7BBD9EE2BDEA0A148EF9B73158B94ABC4C977ADDA9A6A6EA3E15B8F2B2A78B3A33D5FDA95095C7FA2EAAB0DF9A2B02557398CE80DDA93E994B0655F0EA047E57D584427193AA36539FA468AA64BE9D7241610986C2D03DAB60BB85806B2D9AF7CBD58BFF6752E9378CC29B2E6540459FFC820A2204F75FB020346564B98228FE2756714BC1C786B6CF395DC44D8CEA48D474E99CBE2F304301048EF729230BE43368F67196951F157E45610E5D3E46B73838A797394B72064BC6D16D287CAB58843AD3FC65D9A228F3E83229BF5EDDC612404C525C445FD20F39098356EEA9E28A400351C4D0FA4AA3B0252BAE36968F2DD22CA69640B5FADAD07F85A32404B0EC92CED13D5E47B6EB0CFF8297C87F6CDE33EA41FA0D21AA7D7446D03245515663ACC6C39FC0E1207A78FB1FCEC5C7D40C4E0000 , N'6.1.3-40302')
END

